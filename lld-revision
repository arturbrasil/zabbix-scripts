#!/usr/bin/env python3
from pyzabbix import ZabbixAPI
import urllib3
import requests
import urllib3
import sys
import time
import re
import json
import yaml
from datetime import datetime
from collections import Counter


hostname = sys.argv[1]
#hostname = 'OLT FH MCE - CPO'
# Create a time range
time_till = time.mktime(datetime.now().timetuple())
time_from = time_till - 60  * 10 # 10 Minuto

with open(r'credentials.yml') as file:
    credentials = yaml.load(file)

#print(hostname)
#urllib3.disable_warnings()
zabbix = ZabbixAPI("http://localhost/zabbix/")
zabbix.session.verify=False
#zabbix.login(credentials['login'], credentials['password'])
zabbix.login("Admin", "zabbix")
#print("Connected to Zabbix API Version %s" % zabbix.api_version())
pons = []
res = []
host = ""
def get_host(hostname):
    newhost= zabbix.host.get(filter={'name': hostname})
    #print(newhost)
    hostid = newhost[0]['hostid']
    return hostid

def get_items():
    hostid = get_host(hostname)
    #print(hostid)
    items = zabbix.item.get(hostids=hostid, search={ 'key_': "oltPonStatusNum"},startSearch=True,output=['key_', 'name', 'params'])
    #print items
    for item in items:
        filter_item(item)
    pons_counted = Counter(pons)
    for index, key in enumerate(pons_counted, start=0): 
        res.append({'{#PON}' : key, '{#PONVALUE}' : pons_counted[key]})
    resData = {"data": res}
    print(json.dumps(resData))

def filter_item(item):
    #if item['name'] == 'Status da ONU FHTT1079ee10 na PON : 3 / 4': 
    #print item
    #pon_id = m = re.search('[0-9]\/[0-9]', item['name']).group(0) 
    pon_id = m = re.search('(([0-9]){1}|([0-9]){2})\/([0-9])', item['name']).group(0)  
    #print pon_id
    pons.append(pon_id)
    #get_history(item)

get_items()
